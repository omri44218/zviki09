<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×™×¨×•×’×™× ×©×œ ×”×›×™×ª×”</title>
    <style>
        :root { --bg: #f3f4f6; --primary: #2563eb; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .nav { background: white; padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        
        /* Grid & Cards */
        .topics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card { background: white; border-radius: 15px; overflow: hidden; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        
        /* Voting Rows */
        .item-row { display: flex; background: white; border: 3px solid #eee; border-radius: 15px; margin-bottom: 1.2rem; overflow: hidden; transition: 0.3s; }
        .item-row.best { border-color: var(--success); background: #f0fdf4; }
        .item-row.worst { border-color: var(--danger); background: #fef2f2; }
        
        .vote-sidebar { padding: 15px; background: #f8fafc; width: 120px; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid #ddd; gap: 8px; }
        .vote-btn { border: 1px solid #ccc; background: white; padding: 12px 5px; cursor: pointer; border-radius: 10px; font-weight: bold; transition: 0.2s; }
        .vote-btn.active-best { background: var(--success); color: white; border-color: var(--success); }
        .vote-btn.active-worst { background: var(--danger); color: white; border-color: var(--danger); }

        .item-img { width: 140px; height: 140px; object-fit: cover; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; }
        
        /* User Info Bar */
        .user-bar { background: #e5e7eb; padding: 8px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .change-name-btn { background: #fff; border: 1px solid #999; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }

        /* Admin Styles */
        input, textarea { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 8px; }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 0.9rem; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .stats-table th { background: #f8fafc; color: #64748b; }
        .voter-list { font-size: 0.75rem; color: #666; background: #f1f5f9; padding: 5px; border-radius: 5px; margin-top: 5px; display: none; text-align: right; }

        /* Role Badge */
        .role-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #333; color: white; margin-right: 10px; }
        .admin-only, .editor-only { display: none; }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 900; color: var(--primary); font-size: 1.8rem;">RANK IT PRO</div>
    <div>
        <span id="role-display" class="role-badge">×¦×•×¤×”</span>
        <button onclick="loginAdmin()" id="admin-login-btn" style="background:#222; color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">âš™ï¸ ×›× ×™×¡×ª ×¦×•×•×ª</button>
        <button onclick="openAdmin()" id="admin-panel-btn" style="display:none; background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">ğŸ  ×¤×× ×œ × ×™×”×•×œ</button>
    </div>
</div>

<div class="container" id="main-list">
    <div class="topics-grid" id="grid"></div>
</div>

<div id="admin-modal" class="modal">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>×¤×× ×œ × ×™×”×•×œ <small id="panel-role-text" style="font-size: 0.9rem; color: #666;"></small></h2>
            <button onclick="closeModals()" style="background:#eee; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">âœ• ×¡×’×•×¨</button>
        </div>
        
        <div id="editor-section" class="editor-only" style="background: white; padding: 20px; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 30px;">
            <input type="hidden" id="edit-id">
            <input type="text" id="cat-title" placeholder="×©× ×”×§×˜×’×•×¨×™×”">
            <textarea id="cat-desc" placeholder="×ª×™××•×¨..."></textarea>
            <div id="file-wrapper"><input type="file" id="cat-file" accept="image/*"></div>
            <div id="options-container"></div>
            <button onclick="addOptionField()" style="background:#f3f4f6; border:1px solid #ddd; padding:10px; border-radius:8px; cursor:pointer; margin-top:10px;">â• ×”×•×¡×£ ××•×¤×¦×™×”</button>
            <button onclick="saveEverything()" style="background:var(--primary); color:white; width:100%; border:none; padding:15px; margin-top:15px; border-radius:8px; cursor:pointer; font-weight:bold;">×©××•×¨ × ×ª×•× ×™×</button>
        </div>

        <h3>×“×™×¨×•×’×™× ×§×™×™××™×</h3>
        <div id="admin-manage-list"></div>
        <button onclick="logout()" style="margin-top:20px; background:none; border:none; color:red; cursor:pointer; text-decoration:underline;">×”×ª× ×ª×§ ××”××¢×¨×›×ª</button>
    </div>
</div>

<div id="view-modal" class="modal">
    <div class="container" id="view-content"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAtkpNkT3KAOg3RaXVvJkaChTkMS87VKsM",
        authDomain: "project-ratings-e4709.firebaseapp.com",
        projectId: "project-ratings-e4709",
        storageBucket: "project-ratings-e4709.firebasestorage.app",
        messagingSenderId: "1090550356307",
        appId: "1:1090550356307:web:971bacc654a32fa22269a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ××¢×¨×›×ª ×”×¨×©××•×ª ---
    const ROLES = {
        ADMIN: { id: 'admin', label: '×× ×”×œ ××¢×¨×›×ª', pass: '1234' },
        EDITOR: { id: 'editor', label: '×¢×•×¨×š ×ª×•×›×Ÿ', pass: '5678' }
    };

    let currentUserRole = localStorage.getItem('user_role') || 'viewer';

    window.loginAdmin = () => {
        const pass = prompt("×”×›× ×¡ ×¡×™×¡××ª ×’×™×©×”:");
        if (pass === ROLES.ADMIN.pass) {
            currentUserRole = 'admin';
        } else if (pass === ROLES.EDITOR.pass) {
            currentUserRole = 'editor';
        } else {
            alert("×¡×™×¡××” ×©×’×•×™×”");
            return;
        }
        localStorage.setItem('user_role', currentUserRole);
        applyPermissions();
    };

    window.logout = () => {
        localStorage.removeItem('user_role');
        location.reload();
    };

    function applyPermissions() {
        const isAdmin = currentUserRole === 'admin';
        const isEditor = currentUserRole === 'editor' || isAdmin;

        document.getElementById('role-display').innerText = 
            isAdmin ? ROLES.ADMIN.label : (isEditor ? ROLES.EDITOR.label : '×¦×•×¤×”');
        
        document.getElementById('admin-login-btn').style.display = isEditor ? 'none' : 'inline-block';
        document.getElementById('admin-panel-btn').style.display = isEditor ? 'inline-block' : 'none';
        
        // ×”×¦×’×ª ××–×•×¨ ×”×¢×¨×™×›×”
        if (isEditor) {
            const editorSec = document.getElementById('editor-section');
            if(editorSec) editorSec.style.display = 'block';
        }
    }
    
    // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª ×©×œ ×”×¨×©××•×ª
    applyPermissions();

    // --- ×¡×•×£ ××¢×¨×›×ª ×”×¨×©××•×ª ---

    let voterId = localStorage.getItem('voter_id') || Math.random().toString(36).slice(2);
    localStorage.setItem('voter_id', voterId);

    const resizeImg = (file) => new Promise((res) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 400; canvas.height = 300;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 400, 300);
                res(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });

    window.addOptionField = (data = null) => {
        const div = document.createElement('div');
        div.className = "opt-entry";
        div.style = "background:#fafafa; padding:10px; margin-top:10px; border-radius:8px; border:1px solid #eee;";
        div.innerHTML = `
            <input type="hidden" class="opt-id" value="${data ? data.id : ''}">
            <input type="text" class="opt-name" placeholder="×©× ×”××•×¤×¦×™×”" value="${data ? data.name : ''}">
            <textarea class="opt-desc" placeholder="×ª×™××•×¨...">${data ? data.desc : ''}</textarea>
            ${!data ? '<input type="file" class="opt-file" accept="image/*">' : ''}
        `;
        document.getElementById('options-container').appendChild(div);
    };

    window.saveEverything = async () => {
        if (currentUserRole === 'viewer') return alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×‘×¦×¢ ×¤×¢×•×œ×” ×–×•");
        const title = document.getElementById('cat-title').value;
        const editId = document.getElementById('edit-id').value;
        if (!title) return alert("×©× ×§×˜×’×•×¨×™×” ×—×•×‘×”");

        if (editId) {
            await updateDoc(doc(db, "categories", editId), { title, desc: document.getElementById('cat-desc').value });
            const entries = document.querySelectorAll('.opt-entry');
            for (let e of entries) {
                const oId = e.querySelector('.opt-id').value;
                const oName = e.querySelector('.opt-name').value;
                if (oId) await updateDoc(doc(db, "options", oId), { name: oName, desc: e.querySelector('.opt-desc').value });
            }
            location.reload(); return;
        }

        const file = document.getElementById('cat-file').files[0];
        if (!file) return alert("×ª××•× ×ª ×§×˜×’×•×¨×™×” ×—×•×‘×”");
        const catUrl = await resizeImg(file);
        const catDoc = await addDoc(collection(db, "categories"), { title, desc: document.getElementById('cat-desc').value, url: catUrl });
        
        const entries = document.querySelectorAll('.opt-entry');
        for (let e of entries) {
            const oName = e.querySelector('.opt-name').value;
            const oFile = e.querySelector('.opt-file').files[0];
            if (oName && oFile) {
                const oUrl = await resizeImg(oFile);
                await addDoc(collection(db, "options"), { catId: catDoc.id, name: oName, desc: e.querySelector('.opt-desc').value, url: oUrl, order: Date.now() });
            }
        }
        location.reload();
    };

    onSnapshot(collection(db, "categories"), (snap) => {
        const grid = document.getElementById('grid');
        const manage = document.getElementById('admin-manage-list');
        grid.innerHTML = ''; manage.innerHTML = '';
        snap.forEach(d => {
            const data = d.data();
            grid.innerHTML += `<div class="card" onclick="openCategory('${d.id}')"><img src="${data.url}"><div style="padding:15px;"><h3>${data.title}</h3></div></div>`;
            
            // ×›×¤×ª×•×¨×™× ×‘× ×™×”×•×œ ×œ×¤×™ ×”×¨×©××”
            let adminButtons = `<button onclick="fullEdit('${d.id}')">âœï¸ ×¢×¨×•×š</button>`;
            
            if (currentUserRole === 'admin') {
                adminButtons += `
                    <button onclick="showStats('${d.id}')" style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×”</button>
                    <button onclick="deleteCat('${d.id}')" style="color:red; background:none; border:none; cursor:pointer;">××—×§</button>
                `;
            }

            manage.innerHTML += `
                <div style="background:white; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${data.title}</strong>
                        <div>${adminButtons}</div>
                    </div>
                    <div id="stats-${d.id}" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;"></div>
                </div>`;
        });
    });

    window.fullEdit = async (id) => {
        const cat = await getDocs(query(collection(db, "categories"), where("__name__", "==", id)));
        const d = cat.docs[0].data();
        document.getElementById('edit-id').value = id;
        document.getElementById('cat-title').value = d.title;
        document.getElementById('cat-desc').value = d.desc || "";
        document.getElementById('file-wrapper').style.display = 'none';
        document.getElementById('options-container').innerHTML = '';
        const opts = await getDocs(query(collection(db, "options"), where("catId", "==", id)));
        opts.forEach(o => addOptionField({id: o.id, ...o.data()}));
    };

    window.showStats = async (id) => {
        if (currentUserRole !== 'admin') return alert("×¨×§ ×× ×”×œ ×™×›×•×œ ×œ×¨××•×ª ×¡×˜×˜×™×¡×˜×™×§×”");
        const div = document.getElementById(`stats-${id}`);
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
        if (div.style.display === 'block') {
            div.innerHTML = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
            const opts = await getDocs(query(collection(db, "options"), where("catId", "==", id)));
            const votes = await getDocs(query(collection(db, "votes_log"), where("catId", "==", id)));
            
            let html = `<table class="stats-table"><tr><th>××•×¤×¦×™×”</th><th>ğŸ† ×˜×•×‘</th><th>ğŸ’© ×¨×¢</th><th>×¤×™×¨×•×˜</th></tr>`;
            opts.forEach(o => {
                const od = o.data();
                const bVotes = votes.docs.filter(v => v.data().itemId === o.id && v.data().type === 'best');
                const wVotes = votes.docs.filter(v => v.data().itemId === o.id && v.data().type === 'worst');
                
                html += `<tr>
                    <td>${od.name}</td>
                    <td style="color:green; font-weight:bold;">${bVotes.length}</td>
                    <td style="color:red; font-weight:bold;">${wVotes.length}</td>
                    <td>
                        <button style="font-size:0.7rem;" onclick="this.nextElementSibling.style.display='block'">××™ ×”×¦×‘×™×¢?</button>
                        <div class="voter-list">
                            <b>×‘×¢×“:</b> ${bVotes.map(v => v.data().user).join(', ') || '-'}<br>
                            <b>× ×’×“:</b> ${wVotes.map(v => v.data().user).join(', ') || '-'}
                        </div>
                    </td>
                </tr>`;
            });
            div.innerHTML = html + `</table>`;
        }
    };

    window.deleteCat = async (id) => { 
        if (currentUserRole !== 'admin') return alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§");
        if(confirm("×œ××—×•×§?")) await deleteDoc(doc(db, "categories", id)); 
    };

    window.openCategory = (catId) => {
        let name = localStorage.getItem('voter_name');
        if (!name) {
            name = prompt("×”×›× ×¡ ×©× ×œ×“×™×¨×•×’ (×—×“-×¤×¢××™):");
            if (!name) return;
            localStorage.setItem('voter_name', name);
        }
        document.getElementById('view-modal').style.display = 'block';

        onSnapshot(doc(db, "categories", catId), (d) => {
            const cat = d.data();
            const header = `
                <div class="user-bar">
                    <span>××¦×‘×™×¢ ×›: <b>${localStorage.getItem('voter_name')}</b></span>
                    <button class="change-name-btn" onclick="changeName('${catId}')">×©×™× ×•×™ ×©×</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>${cat.title}</h1><button onclick="closeModals()">âœ• ×¡×’×•×¨</button>
                </div><p>${cat.desc || ''}</p>`;
            
            onSnapshot(query(collection(db, "options"), where("catId", "==", catId)), (snap) => {
                let items = []; snap.forEach(od => items.push({id: od.id, ...od.data()}));
                items.sort((a,b) => a.order - b.order);

                let listHtml = '';
                items.forEach(item => {
                    listHtml += `
                        <div class="item-row" id="row-${item.id}">
                            <div class="vote-sidebar">
                                <button class="vote-btn best-btn" onclick="vote('${catId}','${item.id}','best')">ğŸ† ×˜×•×‘</button>
                                <button class="vote-btn worst-btn" onclick="vote('${catId}','${item.id}','worst')">ğŸ’© ×¨×¢</button>
                            </div>
                            <div style="flex:1; padding:15px;"><h3>${item.name}</h3><p>${item.desc || ''}</p></div>
                            <img src="${item.url}" class="item-img">
                        </div>`;
                });
                document.getElementById('view-content').innerHTML = header + listHtml;
                updateVoteUI(catId);
            });
        });
    };

    window.changeName = (catId) => {
        let newName = prompt("×”×›× ×¡ ×©× ×—×“×©:", localStorage.getItem('voter_name'));
        if (newName) {
            localStorage.setItem('voter_name', newName);
            openCategory(catId);
        }
    };

    window.vote = async (catId, itemId, type) => {
        const q = query(collection(db, "votes_log"), where("voterId", "==", voterId), where("catId", "==", catId), where("type", "==", type));
        const existing = await getDocs(q);
        
        for (let d of existing.docs) await deleteDoc(doc(db, "votes_log", d.id));

        if (existing.docs.length === 0 || existing.docs[0].data().itemId !== itemId) {
            await addDoc(collection(db, "votes_log"), {
                voterId, catId, itemId, type, user: localStorage.getItem('voter_name'), time: Date.now()
            });
            const otherType = type === 'best' ? 'worst' : 'best';
            const otherQ = query(collection(db, "votes_log"), where("voterId", "==", voterId), where("catId", "==", catId), where("itemId", "==", itemId), where("type", "==", otherType));
            const otherExisting = await getDocs(otherQ);
            for (let d of otherExisting.docs) await deleteDoc(doc(db, "votes_log", d.id));
        }
        updateVoteUI(catId);
    };

    async function updateVoteUI(catId) {
        const votes = await getDocs(query(collection(db, "votes_log"), where("voterId", "==", voterId), where("catId", "==", catId)));
        document.querySelectorAll('.item-row').forEach(r => r.className = 'item-row');
        document.querySelectorAll('.vote-btn').forEach(b => b.className = b.className.replace(' active-best', '').replace(' active-worst', ''));
        
        votes.forEach(v => {
            const d = v.data();
            const row = document.getElementById(`row-${d.itemId}`);
            if (row) {
                row.classList.add(d.type);
                row.querySelector('.' + d.type + '-btn').classList.add('active-' + d.type);
            }
        });
    }

    window.openAdmin = () => {
        document.getElementById('admin-modal').style.display = 'block';
        document.getElementById('panel-role-text').innerText = `(××—×•×‘×¨ ×‘×ª×•×¨: ${currentUserRole})`;
    };
    
    window.closeModals = () => { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
        // ×œ× ××¨×¢× × ×™× ×›×“×™ ×œ× ×œ××‘×“ ××ª ×”-Login
    };
</script>
</body>
</html>