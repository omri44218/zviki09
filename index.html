<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANK IT PRO - ×”××¢×¨×›×ª ×”××œ××”</title>
    <style>
        :root { --bg: #f3f4f6; --primary: #2563eb; --danger: #ef4444; --success: #10b981; --dark: #1e293b; --text-muted: #64748b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        .nav { background: white; padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
        
        /* ×’×¨×™×“ ×•×”×¦×‘×¢×•×ª */
        .topics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card { background: white; border-radius: 15px; overflow: hidden; border: 1px solid #ddd; cursor: pointer; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .item-row { display: flex; background: white; border: 3px solid #eee; border-radius: 15px; margin-bottom: 1.2rem; overflow: hidden; }
        .item-row.best { border-color: var(--success); background: #f0fdf4; }
        .item-row.worst { border-color: var(--danger); background: #fef2f2; }
        .vote-sidebar { padding: 15px; background: #f8fafc; width: 100px; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid #ddd; gap: 8px; }
        .vote-btn { border: 1px solid #ccc; background: white; padding: 10px 5px; cursor: pointer; border-radius: 10px; font-weight: bold; }
        .vote-btn.active-best { background: var(--success); color: white; border-color: var(--success); }
        .vote-btn.active-worst { background: var(--danger); color: white; border-color: var(--danger); }
        .item-img { width: 140px; height: 140px; object-fit: cover; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; overflow-y: auto; }

        /* ×¦'××˜ ×•×¦×•×•×ª */
        .staff-hub { background: var(--dark); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        .chat-box { height: 150px; overflow-y: auto; background: #0f172a; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .chat-msg { font-size: 0.85rem; padding: 6px 12px; background: #334155; border-radius: 12px; width: fit-content; }
        .chat-msg.me { background: var(--primary); align-self: flex-start; }

        /* ×˜×¤×¡×™× ×•×¢×¨×™×›×” */
        input, textarea { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .opt-entry { border: 2px solid #e2e8f0; padding: 15px; margin-top: 15px; border-radius: 12px; background: #fff; position: relative; }
        .delete-opt-btn { position: absolute; top: 10px; left: 10px; background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; color: #333; }
        .stats-table th, .stats-table td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .help-note { font-size: 0.75rem; color: var(--text-muted); }
    </style>
</head>
<body>

<div class="nav">
    <div style="font-weight: 900; color: var(--primary); font-size: 1.6rem;">RANK IT PRO</div>
    <div>
        <span id="role-display" style="background:#eee; padding:5px 10px; border-radius:15px; font-size:0.8rem;">×¦×•×¤×”</span>
        <button onclick="loginAdmin()" style="border:none; background:none; cursor:pointer;">âš™ï¸</button>
        <button onclick="openAdmin()" id="admin-btn" style="display:none;" class="primary">ğŸ  × ×™×”×•×œ</button>
    </div>
</div>

<div class="container">
    <div class="topics-grid" id="main-grid"></div>
</div>

<div id="admin-modal" class="modal">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>× ×™×”×•×œ ×•×¢×¨×™×›×”</h2>
            <button onclick="closeModals()" style="font-size:1.5rem; border:none; background:none; cursor:pointer;">âœ•</button>
        </div>

        <div id="staff-section" class="staff-hub" style="display:none;">
            <h3>ğŸ’¬ ×¦'××˜ ×¦×•×•×ª</h3>
            <div id="chat-box" class="chat-box"></div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="chat-input" placeholder="×›×ª×•×‘ ×”×•×“×¢×”..." style="margin:0;">
                <button onclick="sendChat()" class="primary">×©×œ×—</button>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; opacity:0.8;">××—×•×‘×¨×™× ×›×¢×ª: <span id="staff-list"></span></div>
        </div>

        <div id="editor-section" style="display:none; background:#fff; padding:20px; border:1px solid #ddd; border-radius:15px; margin-bottom:20px;">
            <h3 id="form-title">×™×¦×™×¨×ª ×§×˜×’×•×¨×™×”</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="cat-title" placeholder="×›×•×ª×¨×ª ×§×˜×’×•×¨×™×”">
            <textarea id="cat-desc" placeholder="×ª×™××•×¨ ×›×œ×œ×™..."></textarea>
            <label class="help-note">×ª××•× ×ª × ×•×©× (×”×¢×œ×” ×œ×”×—×œ×¤×”)</label>
            <input type="file" id="cat-file" accept="image/*">

            <div id="options-container"></div>
            <button onclick="addOptionField()" style="width:100%; padding:10px; cursor:pointer; margin-top:10px;">â• ×”×•×¡×£ ××•×¤×¦×™×” ×œ×“×™×¨×•×’</button>
            <button onclick="saveEverything()" class="primary" style="width:100%; margin-top:20px; padding:15px;">ğŸ’¾ ×©××•×¨ ×‘××ª×¨</button>
            <button onclick="resetForm()" style="width:100%; border:none; background:none; color:gray; cursor:pointer;">×‘×™×˜×•×œ</button>
        </div>

        <h3>×¨×©×™××ª ×§×˜×’×•×¨×™×•×ª</h3>
        <div id="admin-items-list"></div>
        <button onclick="logout()" style="color:red; margin-top:30px; border:none; background:none; cursor:pointer;">×”×ª× ×ª×§</button>
    </div>
</div>

<div id="view-modal" class="modal">
    <div class="container" id="view-content"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, updateDoc, getDocs, setDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAtkpNkT3KAOg3RaXVvJkaChTkMS87VKsM",
        authDomain: "project-ratings-e4709.firebaseapp.com",
        projectId: "project-ratings-e4709",
        storageBucket: "project-ratings-e4709.firebasestorage.app",
        messagingSenderId: "1090550356307",
        appId: "1:1090550356307:web:971bacc654a32fa22269a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let role = localStorage.getItem('user_role') || 'viewer';
    let voterId = localStorage.getItem('voter_id') || Math.random().toString(36).substring(7);

    const resizeImg = (file) => new Promise((res) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 400; canvas.height = 300;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 400, 300);
                res(canvas.toDataURL('image/jpeg', 0.7));
            };
        };
    });

    window.loginAdmin = () => {
        const p = prompt("×¡×™×¡××”:");
        if (p === 'zviki098') role = 'admin';
        else if (p === 'zviki643') role = 'editor';
        else return;
        localStorage.setItem('user_role', role);
        location.reload();
    };

    window.logout = () => { localStorage.removeItem('user_role'); location.reload(); };

    if (role !== 'viewer') {
        document.getElementById('admin-btn').style.display = 'inline';
        document.getElementById('editor-section').style.display = 'block';
        document.getElementById('staff-section').style.display = 'block';
        document.getElementById('role-display').innerText = role === 'admin' ? '×× ×”×œ' : '×¢×•×¨×š';
        setDoc(doc(db, "staff_online", voterId), { name: localStorage.getItem('voter_name') || '××™×© ×¦×•×•×ª', time: serverTimestamp() });
    }

    // ×¦'××˜
    onSnapshot(query(collection(db, "staff_chat"), orderBy("time", "asc"), limit(50)), (s) => {
        const b = document.getElementById('chat-box'); b.innerHTML = '';
        s.forEach(d => { const m = d.data(); b.innerHTML += `<div class="chat-msg ${m.uid===voterId?'me':''}"><b>${m.user}:</b> ${m.text}</div>`; });
        b.scrollTop = b.scrollHeight;
    });

    window.sendChat = async () => {
        const i = document.getElementById('chat-input'); if(!i.value) return;
        await addDoc(collection(db, "staff_chat"), { text: i.value, user: localStorage.getItem('voter_name') || '×¦×•×•×ª', uid: voterId, time: serverTimestamp() });
        i.value = '';
    };

    onSnapshot(collection(db, "staff_online"), (s) => {
        let n = []; s.forEach(d => n.push(d.data().name)); document.getElementById('staff-list').innerText = n.join(', ');
    });

    // × ×™×”×•×œ ××•×¤×¦×™×•×ª ×•×¢×¨×™×›×”
    window.addOptionField = (data = null) => {
        const div = document.createElement('div');
        div.className = "opt-entry";
        div.innerHTML = `
            <button class="delete-opt-btn" onclick="removeOptionUI(this, '${data ? data.id : ''}')">ğŸ—‘ï¸</button>
            <input type="hidden" class="opt-id" value="${data ? data.id : ''}">
            <input type="text" class="opt-name" placeholder="×©× ×”××•×¤×¦×™×”" value="${data ? data.name : ''}">
            <textarea class="opt-desc" placeholder="×ª×™××•×¨ ×”××•×¤×¦×™×”...">${data ? (data.desc || '') : ''}</textarea>
            <input type="file" class="opt-file" accept="image/*">
        `;
        document.getElementById('options-container').appendChild(div);
    };

    window.removeOptionUI = async (btn, id) => {
        if (!confirm("×œ××—×•×§ ××•×¤×¦×™×” ×–×•?")) return;
        if (id) await deleteDoc(doc(db, "options", id));
        btn.parentElement.remove();
    };

    window.saveEverything = async () => {
        const title = document.getElementById('cat-title').value;
        const editId = document.getElementById('edit-id').value;
        const catFile = document.getElementById('cat-file').files[0];
        if (!title) return alert("×—×•×‘×” ×©×");

        let updateData = { title, desc: document.getElementById('cat-desc').value };
        if (catFile) updateData.url = await resizeImg(catFile);

        let finalId = editId;
        if (editId) await updateDoc(doc(db, "categories", editId), updateData);
        else {
            if (!catFile) return alert("×—×•×‘×” ×ª××•× ×” ×œ×§×˜×’×•×¨×™×”");
            const dr = await addDoc(collection(db, "categories"), updateData);
            finalId = dr.id;
        }

        for (let e of document.querySelectorAll('.opt-entry')) {
            const oId = e.querySelector('.opt-id').value;
            const oName = e.querySelector('.opt-name').value;
            const oDesc = e.querySelector('.opt-desc').value;
            const oFile = e.querySelector('.opt-file').files[0];
            let oData = { name: oName, desc: oDesc, catId: finalId };
            if (oFile) oData.url = await resizeImg(oFile);
            if (oId) await updateDoc(doc(db, "options", oId), oData);
            else if (oName) { oData.order = Date.now(); await addDoc(collection(db, "options"), oData); }
        }
        alert("× ×©××¨!"); resetForm();
    };

    window.resetForm = () => {
        document.getElementById('edit-id').value = '';
        document.getElementById('cat-title').value = '';
        document.getElementById('cat-desc').value = '';
        document.getElementById('options-container').innerHTML = '';
        document.getElementById('form-title').innerText = "×™×¦×™×¨×ª ×§×˜×’×•×¨×™×”";
    };

    onSnapshot(collection(db, "categories"), (s) => {
        const g = document.getElementById('main-grid'); const al = document.getElementById('admin-items-list');
        g.innerHTML = ''; al.innerHTML = '';
        s.forEach(d => {
            const data = d.data();
            g.innerHTML += `<div class="card" onclick="openCategory('${d.id}')"><img src="${data.url}"><div style="padding:10px;"><h3>${data.title}</h3></div></div>`;
            al.innerHTML += `<div style="background:#fff; padding:15px; border-bottom:2px solid #eee; margin-bottom:10px; border-radius:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong>${data.title}</strong>
                    <div>
                        <button onclick="fullEdit('${d.id}')">âœï¸</button>
                        <button onclick="showStats('${d.id}')" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ“Š</button>
                        ${role==='admin' ? `<button onclick="deleteCat('${d.id}')" style="color:red;">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </div>
                <div id="stats-${d.id}" style="display:none; margin-top:10px;"></div>
            </div>`;
        });
    });

    window.showStats = async (catId) => {
        const div = document.getElementById(`stats-${catId}`);
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
        if (div.style.display === 'block') {
            const os = await getDocs(query(collection(db, "options"), where("catId", "==", catId)));
            const vs = await getDocs(query(collection(db, "votes_log"), where("catId", "==", catId)));
            let h = `<table class="stats-table"><tr><th>×¤×¨×™×˜</th><th>ğŸ†</th><th>ğŸ’©</th></tr>`;
            os.forEach(o => {
                const b = vs.docs.filter(v => v.data().itemId === o.id && v.data().type === 'best').length;
                const w = vs.docs.filter(v => v.data().itemId === o.id && v.data().type === 'worst').length;
                h += `<tr><td>${o.data().name}</td><td>${b}</td><td>${w}</td></tr>`;
            });
            div.innerHTML = h + `</table>`;
        }
    };

    window.fullEdit = async (id) => {
        const s = await getDocs(query(collection(db, "categories"), where("__name__", "==", id)));
        const d = s.docs[0].data();
        document.getElementById('edit-id').value = id;
        document.getElementById('cat-title').value = d.title;
        document.getElementById('cat-desc').value = d.desc || '';
        document.getElementById('form-title').innerText = "×¢×¨×™×›×ª: " + d.title;
        document.getElementById('options-container').innerHTML = '';
        const os = await getDocs(query(collection(db, "options"), where("catId", "==", id)));
        os.forEach(o => addOptionField({id: o.id, ...o.data()}));
        document.getElementById('admin-modal').scrollTop = 0;
    };

    window.deleteCat = async (id) => { if(confirm("×œ××—×•×§ ×”×›×œ?")) await deleteDoc(doc(db, "categories", id)); };

    // ×”×¦×‘×¢×•×ª
    window.openCategory = (id) => {
        let n = localStorage.getItem('voter_name');
        if (!n) { n = prompt("×©×:"); if (!n) return; localStorage.setItem('voter_name', n); }
        document.getElementById('view-modal').style.display = 'block';
        onSnapshot(doc(db, "categories", id), (d) => {
            const cat = d.data();
            onSnapshot(query(collection(db, "options"), where("catId", "==", id)), (snap) => {
                let h = `<div style="display:flex; justify-content:space-between; align-items:center;"><h1>${cat.title}</h1><button onclick="closeModals()" style="font-size:2rem; border:none; background:none; cursor:pointer;">âœ•</button></div><p>${cat.desc||''}</p>`;
                let items = []; snap.forEach(o => items.push({id: o.id, ...o.data()}));
                items.sort((a,b)=>a.order-b.order).forEach(item => {
                    h += `<div class="item-row" id="row-${item.id}">
                        <div class="vote-sidebar">
                            <button class="vote-btn best-btn" onclick="vote('${id}','${item.id}','best')">ğŸ†</button>
                            <button class="vote-btn worst-btn" onclick="vote('${id}','${item.id}','worst')">ğŸ’©</button>
                        </div>
                        <div style="flex:1; padding:15px;"><h3>${item.name}</h3><p style="font-size:0.85rem; color:#666;">${item.desc||''}</p></div>
                        <img src="${item.url}" class="item-img">
                    </div>`;
                });
                document.getElementById('view-content').innerHTML = h; updateVoteUI(id);
            });
        });
    };

    window.vote = async (cid, iid, type) => {
        const q = query(collection(db, "votes_log"), where("voterId", "==", voterId), where("catId", "==", cid), where("type", "==", type));
        const s = await getDocs(q); for (let d of s.docs) await deleteDoc(doc(db, "votes_log", d.id));
        if (s.docs.length === 0 || s.docs[0].data().itemId !== iid) {
            await addDoc(collection(db, "votes_log"), { voterId, catId: cid, itemId: iid, type, user: localStorage.getItem('voter_name'), time: Date.now() });
            const oq = query(collection(db, "votes_log"), where("voterId", "==", voterId), where("itemId", "==", iid), where("type", "==", type==='best'?'worst':'best'));
            const os = await getDocs(oq); for (let d of os.docs) await deleteDoc(doc(db, "votes_log", d.id));
        }
        updateVoteUI(cid);
    };

    async function updateVoteUI(cid) {
        const s = await getDocs(query(collection(db, "votes_log"), where("voterId", "==", voterId), where("catId", "==", cid)));
        document.querySelectorAll('.item-row').forEach(r => r.className = 'item-row');
        document.querySelectorAll('.vote-btn').forEach(b => b.classList.remove('active-best', 'active-worst'));
        s.forEach(v => {
            const d = v.data(); const r = document.getElementById(`row-${d.itemId}`);
            if(r) { r.classList.add(d.type); r.querySelector('.'+d.type+'-btn').classList.add('active-'+d.type); }
        });
    }

    window.openAdmin = () => document.getElementById('admin-modal').style.display = 'block';
    window.closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    window.fullEdit = fullEdit; window.deleteCat = deleteCat; window.showStats = showStats; 
    window.openCategory = openCategory; window.vote = vote; window.addOptionField = addOptionField; 
    window.saveEverything = saveEverything; window.sendChat = sendChat; window.resetForm = resetForm; window.removeOptionUI = removeOptionUI;
</script>
</body>
</html>


